#!/bin/bash
# ==============================================================================
# PROJECT CHIMERA | DEV TOOLKIT
# ==============================================================================
# TARGET:    Fedora 43 Desktop
# ROLE:      Full-Stack Developer Environment (Newbie-Friendly)
# HARDWARE:  AMD 7700 / Intel Arc 770 / 32GB RAM
# ==============================================================================

set -e

REAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[!] Run as root: sudo bash <script>${NC}"
    exit 1
fi

echo -e "${CYAN}"
cat << "EOF"
  ┌──────────────────────────────────────────┐
  │    CHIMERA DEV TOOLKIT INSTALLER         │
  │    Fedora 43 · Full Stack Environment    │
  └──────────────────────────────────────────┘
EOF
echo -e "${NC}"

# ==============================================================================
# PHASE 1: BUILD ESSENTIALS & SYSTEM DEPS
# ==============================================================================
echo -e "${BLUE}[1/9]${NC} Installing build essentials..."
dnf groupinstall -y "Development Tools" "C Development Tools and Libraries"
dnf install -y \
    gcc gcc-c++ make cmake ninja-build \
    openssl-devel zlib-devel bzip2-devel \
    readline-devel sqlite-devel libffi-devel \
    xz-devel tk-devel ncurses-devel \
    libxml2-devel libxslt-devel \
    kernel-devel kernel-headers \
    pkg-config autoconf automake libtool

# ==============================================================================
# PHASE 2: VISUAL STUDIO CODE
# ==============================================================================
echo -e "${BLUE}[2/9]${NC} Installing Visual Studio Code..."
if ! command -v code &>/dev/null; then
    rpm --import https://packages.microsoft.com/keys/microsoft.asc
    cat > /etc/yum.repos.d/vscode.repo << 'VSREPO'
[code]
name=Visual Studio Code
baseurl=https://packages.microsoft.com/yumrepos/vscode
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc
VSREPO
    dnf install -y code
    echo -e "  ${GREEN}✓${NC} VS Code installed"
else
    echo -e "  ${GREEN}✓${NC} VS Code already installed"
fi

# Install essential VS Code extensions for the user
echo -e "  Installing VS Code extensions..."
VSCODE_EXTENSIONS=(
    "ms-python.python"
    "ms-python.vscode-pylance"
    "charliermarsh.ruff"
    "rust-lang.rust-analyzer"
    "golang.go"
    "bradlc.vscode-tailwindcss"
    "esbenp.prettier-vscode"
    "dbaeumer.vscode-eslint"
    "eamodio.gitlens"
    "ms-azuretools.vscode-docker"
    "redhat.vscode-yaml"
    "tamasfe.even-better-toml"
    "usernamehw.errorlens"
    "PKief.material-icon-theme"
    "GitHub.copilot"
    "ms-vscode-remote.remote-containers"
    "continue.continue"
)

for ext in "${VSCODE_EXTENSIONS[@]}"; do
    sudo -u "$REAL_USER" code --install-extension "$ext" --force 2>/dev/null || true
done
echo -e "  ${GREEN}✓${NC} VS Code extensions installed"

# ==============================================================================
# PHASE 3: NEOVIM + KICKSTART CONFIG
# ==============================================================================
echo -e "${BLUE}[3/9]${NC} Installing Neovim..."
dnf install -y neovim python3-neovim
echo -e "  ${GREEN}✓${NC} Neovim installed"

# Install kickstart.nvim for a modern IDE experience
NVIM_DIR="$USER_HOME/.config/nvim"
if [ ! -d "$NVIM_DIR" ]; then
    echo -e "  Cloning kickstart.nvim..."
    sudo -u "$REAL_USER" git clone https://github.com/nvim-lua/kickstart.nvim.git "$NVIM_DIR" 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} kickstart.nvim configured"
else
    echo -e "  ${GREEN}✓${NC} Neovim config already exists"
fi

# ==============================================================================
# PHASE 4: PROGRAMMING LANGUAGES
# ==============================================================================
echo -e "${BLUE}[4/9]${NC} Installing programming languages..."

# --- Python (system + pyenv for version management) ---
echo -e "  ${CYAN}Python:${NC}"
dnf install -y python3 python3-pip python3-devel
# Install pyenv for the user
if [ ! -d "$USER_HOME/.pyenv" ]; then
    sudo -u "$REAL_USER" bash -c 'curl -fsSL https://pyenv.run | bash' 2>/dev/null || true
fi
# Python dev tools via pipx
dnf install -y pipx
sudo -u "$REAL_USER" pipx ensurepath 2>/dev/null || true
for tool in ruff mypy black isort poetry httpie cookiecutter; do
    sudo -u "$REAL_USER" pipx install "$tool" 2>/dev/null || true
done
echo -e "  ${GREEN}✓${NC} Python + ruff, mypy, black, poetry, httpie"

# --- Node.js (via dnf module or nvm) ---
echo -e "  ${CYAN}Node.js:${NC}"
if ! command -v node &>/dev/null; then
    dnf install -y nodejs npm
fi
# Install common global packages
sudo -u "$REAL_USER" npm install -g pnpm yarn typescript ts-node 2>/dev/null || true
echo -e "  ${GREEN}✓${NC} Node.js + pnpm, yarn, typescript"

# --- Rust ---
echo -e "  ${CYAN}Rust:${NC}"
if [ ! -d "$USER_HOME/.cargo" ]; then
    sudo -u "$REAL_USER" bash -c 'curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y' 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} Rust (rustup) installed"
else
    echo -e "  ${GREEN}✓${NC} Rust already installed"
fi

# --- Go ---
echo -e "  ${CYAN}Go:${NC}"
dnf install -y golang
echo -e "  ${GREEN}✓${NC} Go installed"

# --- Java (OpenJDK) ---
echo -e "  ${CYAN}Java:${NC}"
dnf install -y java-21-openjdk java-21-openjdk-devel
echo -e "  ${GREEN}✓${NC} Java 21 (OpenJDK) installed"

# ==============================================================================
# PHASE 5: MODERN CLI TOOLS
# ==============================================================================
echo -e "${BLUE}[5/9]${NC} Installing modern CLI tools..."

# Available in Fedora repos
dnf install -y \
    ripgrep \
    fd-find \
    bat \
    eza \
    fzf \
    jq \
    yq \
    httpie \
    tree \
    htop \
    btop \
    tldr \
    trash-cli \
    ShellCheck \
    tokei \
    hyperfine \
    procs \
    sd

# lazygit (Git TUI)
if ! command -v lazygit &>/dev/null; then
    dnf copr enable -y atim/lazygit 2>/dev/null || true
    dnf install -y lazygit 2>/dev/null || true
fi

# git-delta (better diffs)
if ! command -v delta &>/dev/null; then
    dnf install -y git-delta 2>/dev/null || true
fi

# zoxide (smarter cd)
if ! command -v zoxide &>/dev/null; then
    dnf install -y zoxide 2>/dev/null || true
fi

echo -e "  ${GREEN}✓${NC} ripgrep, fd, bat, eza, fzf, lazygit, delta, btop, zoxide"

# ==============================================================================
# PHASE 6: ZSH + OH MY ZSH + STARSHIP
# ==============================================================================
echo -e "${BLUE}[6/9]${NC} Installing Zsh + Oh My Zsh + Starship prompt..."

dnf install -y zsh

# Install Oh My Zsh
if [ ! -d "$USER_HOME/.oh-my-zsh" ]; then
    sudo -u "$REAL_USER" bash -c \
        'RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"' 2>/dev/null || true
fi

# Install zsh plugins
ZSH_CUSTOM="$USER_HOME/.oh-my-zsh/custom"
if [ -d "$ZSH_CUSTOM" ]; then
    if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
        sudo -u "$REAL_USER" git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions" 2>/dev/null || true
    fi
    if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
        sudo -u "$REAL_USER" git clone https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" 2>/dev/null || true
    fi
    if [ ! -d "$ZSH_CUSTOM/plugins/fzf-tab" ]; then
        sudo -u "$REAL_USER" git clone https://github.com/Aloxaf/fzf-tab "$ZSH_CUSTOM/plugins/fzf-tab" 2>/dev/null || true
    fi
fi

# Install Starship prompt
if ! command -v starship &>/dev/null; then
    dnf install -y starship 2>/dev/null || \
        curl -sS https://starship.rs/install.sh | sh -s -- -y 2>/dev/null || true
fi

# Configure .zshrc
ZSHRC="$USER_HOME/.zshrc"
if [ -f "$ZSHRC" ] && ! grep -q "# CHIMERA DEV TOOLKIT" "$ZSHRC"; then
    cat >> "$ZSHRC" << 'ZSHCONF'

# CHIMERA DEV TOOLKIT
plugins=(git docker docker-compose python rust golang npm fzf zsh-autosuggestions zsh-syntax-highlighting fzf-tab)

# Modern aliases
alias ls='eza --icons --group-directories-first'
alias ll='eza -la --icons --group-directories-first --git'
alias lt='eza --tree --icons -L 2'
alias cat='bat --paging=never'
alias find='fd'
alias grep='rg'
alias top='btop'
alias lg='lazygit'
alias rm='trash-put'
alias diff='delta'
alias cd='z'

# Starship prompt
eval "$(starship init zsh)"

# Zoxide
eval "$(zoxide init zsh)"

# FZF
source /usr/share/fzf/shell/key-bindings.zsh 2>/dev/null
source /usr/share/fzf/shell/completion.zsh 2>/dev/null
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8'

# Pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d "$PYENV_ROOT/bin" ]] && export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)" 2>/dev/null

# Rust
source "$HOME/.cargo/env" 2>/dev/null

# Go
export GOPATH="$HOME/go"
export PATH="$PATH:$GOPATH/bin"
ZSHCONF
fi
chown "$REAL_USER:$REAL_USER" "$ZSHRC"

# Set Zsh as default shell
chsh -s "$(which zsh)" "$REAL_USER"
echo -e "  ${GREEN}✓${NC} Zsh + Oh My Zsh + Starship + plugins"

# ==============================================================================
# PHASE 7: CONTAINERS & ORCHESTRATION
# ==============================================================================
echo -e "${BLUE}[7/9]${NC} Installing container tools..."

# Podman (Fedora native) should already be installed
dnf install -y podman podman-compose buildah skopeo toolbox distrobox

# Docker CE (for compatibility)
if ! command -v docker &>/dev/null; then
    dnf config-manager addrepo --from-repofile=https://download.docker.com/linux/fedora/docker-ce.repo 2>/dev/null || true
    dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin 2>/dev/null || true
    systemctl enable --now docker 2>/dev/null || true
    usermod -aG docker "$REAL_USER" 2>/dev/null || true
fi
echo -e "  ${GREEN}✓${NC} Podman, Docker, Buildah, Distrobox"

# ==============================================================================
# PHASE 8: DATABASE & API TOOLS
# ==============================================================================
echo -e "${BLUE}[8/9]${NC} Installing database & API tools..."

dnf install -y \
    postgresql \
    sqlite \
    redis

# DBeaver (universal DB client) via Flatpak
flatpak install -y flathub io.dbeaver.DBeaverCommunity 2>/dev/null || true

# pgcli + litecli (smart CLI for Postgres/SQLite)
sudo -u "$REAL_USER" pipx install pgcli 2>/dev/null || true
sudo -u "$REAL_USER" pipx install litecli 2>/dev/null || true

echo -e "  ${GREEN}✓${NC} PostgreSQL, SQLite, Redis, DBeaver, pgcli, litecli"

# ==============================================================================
# PHASE 9: GIT CONFIGURATION
# ==============================================================================
echo -e "${BLUE}[9/9]${NC} Configuring Git..."

# Git config (only set if not already configured)
if ! sudo -u "$REAL_USER" git config --global user.name &>/dev/null; then
    echo -e "  ${YELLOW}[!]${NC} Git user.name not set — set it with: git config --global user.name 'Your Name'"
fi
if ! sudo -u "$REAL_USER" git config --global user.email &>/dev/null; then
    echo -e "  ${YELLOW}[!]${NC} Git user.email not set — set it with: git config --global user.email 'you@example.com'"
fi

# Git quality-of-life settings
sudo -u "$REAL_USER" git config --global init.defaultBranch main
sudo -u "$REAL_USER" git config --global core.pager delta
sudo -u "$REAL_USER" git config --global interactive.diffFilter 'delta --color-only'
sudo -u "$REAL_USER" git config --global delta.navigate true
sudo -u "$REAL_USER" git config --global delta.light false
sudo -u "$REAL_USER" git config --global delta.side-by-side true
sudo -u "$REAL_USER" git config --global delta.line-numbers true
sudo -u "$REAL_USER" git config --global merge.conflictstyle diff3
sudo -u "$REAL_USER" git config --global diff.colorMoved default
sudo -u "$REAL_USER" git config --global pull.rebase true
sudo -u "$REAL_USER" git config --global push.autoSetupRemote true
sudo -u "$REAL_USER" git config --global rerere.enabled true

echo -e "  ${GREEN}✓${NC} Git configured with delta, rebase, rerere"

# ==============================================================================
# DONE
# ==============================================================================
echo -e ""
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║            DEV TOOLKIT INSTALLATION COMPLETE                  ║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${CYAN}Editors:${NC}"
echo -e "  ✓ VS Code (code) + 17 extensions"
echo -e "  ✓ Neovim + kickstart.nvim"
echo ""
echo -e "${CYAN}Languages:${NC}"
echo -e "  ✓ Python 3 + pyenv + ruff/mypy/black/poetry"
echo -e "  ✓ Node.js + pnpm/yarn/typescript"
echo -e "  ✓ Rust (rustup + cargo)"
echo -e "  ✓ Go"
echo -e "  ✓ Java 21 (OpenJDK)"
echo ""
echo -e "${CYAN}CLI Tools:${NC}"
echo -e "  ✓ ripgrep, fd, bat, eza, fzf, lazygit, delta, btop, zoxide"
echo -e "  ✓ Zsh + Oh My Zsh + Starship prompt"
echo ""
echo -e "${CYAN}Containers:${NC}"
echo -e "  ✓ Docker + Podman + Buildah + Distrobox"
echo ""
echo -e "${CYAN}Databases:${NC}"
echo -e "  ✓ PostgreSQL, SQLite, Redis, DBeaver"
echo ""
echo -e "${YELLOW}Next Steps:${NC}"
echo -e "  1. Log out and back in (or run: exec zsh)"
echo -e "  2. Open VS Code: code ."
echo -e "  3. Open Neovim: nvim (plugins install on first run)"
echo -e "  4. Set your Git identity if not already done"
echo ""
