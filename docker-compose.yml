################################################################################
#  BRAIN AI STACK - Portainer Edition v2
#  Pop!_OS 24.04 | Intel Ultra 7 265F | AMD RX 7900 XT (20GB) | 128GB RAM
#
#  vLLM runs BARE METAL (port 8000) - this stack connects to it
#  Ollama (11434) + Open WebUI (3000) are already installed on the host
#  and are not deployed by this stack.
#  Deploy via: Portainer > Stacks > Add Stack > Upload
################################################################################

networks:
  brain-network:
    driver: bridge

x-dns: &dns
  - 1.1.1.1
  - 8.8.8.8

volumes:
  anythingllm_data:
  qdrant_data:
  searxng_data:
  whisper_data:
  piper_data:

services:
  #============================================================================
  # ANYTHINGLLM - RAG & Document Processing
  #============================================================================
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: brain_anythingllm
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${ANYTHINGLLM_PORT:-3001}:3001"
    volumes:
      - anythingllm_data:/app/server/storage
    environment:
      - STORAGE_DIR=/app/server/storage
      # Use vLLM as primary LLM
      - LLM_PROVIDER=openai
      - OPENAI_BASE_PATH=http://host.docker.internal:${VLLM_PORT:-8000}/v1
      - OPENAI_API_KEY=sk-no-key-needed
      - OPENAI_MODEL_PREF=dolphin-2.9.3-mistral-nemo-12b
      # Embeddings via host Ollama (11434)
      - EMBEDDING_ENGINE=ollama
      - EMBEDDING_BASE_PATH=http://host.docker.internal:11434
      - EMBEDDING_MODEL_PREF=nomic-embed-text:latest
      # Vector DB
      - VECTOR_DB=qdrant
      - QDRANT_ENDPOINT=http://qdrant:6333
    dns: *dns
    extra_hosts:
      - "host.docker.internal:host-gateway"
    cap_add:
      - SYS_ADMIN
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  #============================================================================
  # QDRANT - Vector Database for RAG
  #============================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: brain_qdrant
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    dns: *dns
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  #============================================================================
  # SEARXNG - Private Search Engine
  #============================================================================
  searxng:
    image: searxng/searxng:latest
    container_name: brain_searxng
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${SEARXNG_PORT:-8888}:8080"
    volumes:
      - searxng_data:/etc/searxng
    environment:
      - SEARXNG_BASE_URL=http://localhost:${SEARXNG_PORT:-8888}
      - INSTANCE_NAME=Brain Search
    dns: *dns
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  #============================================================================
  # WHISPER - Speech to Text (for Home Assistant Wyoming)
  #============================================================================
  whisper:
    image: rhasspy/wyoming-whisper:latest
    container_name: brain_whisper
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${WHISPER_PORT:-10300}:10300"
    volumes:
      - whisper_data:/data
    command: 
      - "--model"
      - "small-int8"
      - "--language"
      - "en"
      - "--beam-size"
      - "1"
      - "--device"
      - "cpu"
    dns: *dns
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "10300"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  #============================================================================
  # PIPER - Text to Speech (for Home Assistant Wyoming)
  #============================================================================
  piper:
    image: rhasspy/wyoming-piper:latest
    container_name: brain_piper
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${PIPER_PORT:-10200}:10200"
    volumes:
      - piper_data:/data
    command:
      - "--voice"
      - "en_US-lessac-medium"
    dns: *dns
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "10200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  #============================================================================
  # HOMEPAGE - Dashboard Launcher
  #============================================================================
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: brain_homepage
    restart: unless-stopped
    networks:
      - brain-network
    env_file:
      - ./stack.env
    ports:
      - "${HOMEPAGE_PORT:-80}:3000"
    volumes:
      - ./homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PUID=1000
      - PGID=1000
    dns: *dns
