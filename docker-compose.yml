name: chimera-brain-stack

services:
  ollama-rocm:
    image: ollama/ollama:rocm
    container_name: chimera-ollama
    restart: unless-stopped
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    environment:
      - HSA_OVERRIDE_GFX_VERSION=11.0.0
      - OLLAMA_KEEP_ALIVE=${OLLAMA_KEEP_ALIVE:-5m}
    group_add:
      - video
      - render
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/ollama:/root/.ollama
    ports:
      - "11434:11434"

  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: chimera-openwebui
    restart: unless-stopped
    depends_on:
      - qdrant
      - ollama-rocm
    environment:
      - TZ=${TZ:-America/New_York}
      - VECTOR_DB=qdrant
      - QDRANT_URI=http://qdrant:6333
      - OLLAMA_BASE_URL=http://ollama-rocm:11434
      - OPENAI_API_BASE_URL=http://host.docker.internal:8000/v1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/openwebui:/app/backend/data
    ports:
      - "3000:8080"

  qdrant:
    image: qdrant/qdrant:latest
    container_name: chimera-qdrant
    restart: unless-stopped
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/qdrant/storage:/qdrant/storage
      - ${APPDATA_PATH:-/opt/chimera/appdata}/qdrant/snapshots:/qdrant/snapshots
    ports:
      - "6333:6333"

  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: chimera-anythingllm
    restart: unless-stopped
    depends_on:
      - qdrant
      - searxng
    environment:
      - TZ=${TZ:-America/New_York}
      - STORAGE_DIR=/app/server/storage
      - VECTOR_DB=qdrant
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - SEARXNG_ENDPOINT=http://searxng:8080
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/anythingllm:/app/server/storage
    ports:
      - "3001:3001"

  searxng:
    image: searxng/searxng:latest
    container_name: chimera-searxng
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - BASE_URL=${SEARXNG_BASE_URL:-http://localhost:8888/}
    volumes:
      - ./brain-config/searxng/settings.yml:/etc/searxng/settings.yml:ro
      - ./brain-config/searxng/limiter.toml:/etc/searxng/limiter.toml:ro
    ports:
      - "8888:8080"

  wyoming-whisper:
    image: rhasspy/wyoming-whisper:latest
    container_name: chimera-whisper
    restart: unless-stopped
    command: --model medium --language en
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/whisper:/data
    ports:
      - "10300:10300"

  wyoming-piper:
    image: rhasspy/wyoming-piper:latest
    container_name: chimera-piper
    restart: unless-stopped
    command: --voice en_US-amy-medium
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/piper:/data
    ports:
      - "10200:10200"

  moltbot:
    image: node:22-bookworm-slim
    container_name: chimera-moltbot
    restart: unless-stopped
    depends_on:
      - ollama-rocm
    environment:
      - TZ=${TZ:-America/New_York}
      - MOLTBOT_HOME=/data
      - NODE_ENV=production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ${APPDATA_PATH:-/opt/chimera/appdata}/moltbot:/data
      - ./brain-config/moltbot/moltbot.json.example:/data/moltbot.json:ro
    ports:
      - "18789:18789"
      - "18793:18793"
    command: >-
      sh -c "npm install -g moltbot@latest &&
      moltbot gateway --config /data/moltbot.json"
